@{
    ViewData["Title"] = "Randevu Raporu";
}

<div class="container mt-5">
    <h2>📊 Randevu Raporu (REST API)</h2>
    <hr />

    <!-- Tarih Filtreleme -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">📅 Tarih Filtresi</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Tarih Seç:</label>
                    <input type="date" id="filterDate" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button id="btnFilterByDate" class="btn btn-primary d-block w-100">
                        🔍 Filtrele
                    </button>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button id="btnShowAll" class="btn btn-secondary d-block w-100">
                        📋 Tümünü Göster
                    </button>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button id="btnStatistics" class="btn btn-info d-block w-100">
                        📈 İstatistik
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- İstatistikler (Gizli) -->
    <div id="statisticsCard" class="card mb-4" style="display:none;">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">📈 Genel İstatistikler</h5>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-2">
                    <h3 id="statTotal">0</h3>
                    <small>Toplam</small>
                </div>
                <div class="col-md-2">
                    <h3 id="statPending" class="text-warning">0</h3>
                    <small>Bekleyen</small>
                </div>
                <div class="col-md-2">
                    <h3 id="statConfirmed" class="text-success">0</h3>
                    <small>Onaylı</small>
                </div>
                <div class="col-md-2">
                    <h3 id="statCompleted" class="text-info">0</h3>
                    <small>Tamamlanan</small>
                </div>
                <div class="col-md-2">
                    <h3 id="statCancelled" class="text-danger">0</h3>
                    <small>İptal</small>
                </div>
                <div class="col-md-2">
                    <h3 id="statRevenue" class="text-primary">0₺</h3>
                    <small>Gelir</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="text-center" style="display:none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Yükleniyor...</span>
        </div>
        <p>Veriler yükleniyor...</p>
    </div>

    <!-- Sonuç Tablosu -->
    <div class="card">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">📋 Randevular (<span id="resultCount">0</span>)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="appointmentsTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Tarih</th>
                            <th>Saat</th>
                            <th>Üye</th>
                            <th>Antrenör</th>
                            <th>Hizmet</th>
                            <th>Fiyat</th>
                            <th>Durum</th>
                        </tr>
                    </thead>
                    <tbody id="appointmentsBody">
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                Tarih seçin veya "Tümünü Göster" butonuna tıklayın
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a asp-action="Index" class="btn btn-secondary">← Geri Dön</a>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            
            // Tarih seçilince otomatik bugünün tarihi
            $('#filterDate').val(new Date().toISOString().split('T')[0]);

            // Tarih filtreleme
            $('#btnFilterByDate').click(function() {
                const date = $('#filterDate').val();
                if (!date) {
                    alert('Lütfen bir tarih seçin!');
                    return;
                }
                loadAppointmentsByDate(date);
            });

            // Tümünü göster
            $('#btnShowAll').click(function() {
                loadAllAppointments();
            });

            // İstatistik göster
            $('#btnStatistics').click(function() {
                loadStatistics();
            });

            // Tarih ile randevuları yükle (REST API)
            function loadAppointmentsByDate(date) {
                $('#loading').show();
                $('#appointmentsBody').html('');

                $.ajax({
                    url: '/api/AppointmentsApi/ByDate',
                    type: 'GET',
                    data: { date: date },
                    success: function(data) {
                        $('#loading').hide();
                        displayAppointments(data);
                    },
                    error: function() {
                        $('#loading').hide();
                        alert('Veri yüklenirken hata oluştu!');
                    }
                });
            }

            // Tüm randevuları yükle (REST API)
            function loadAllAppointments() {
                $('#loading').show();
                $('#appointmentsBody').html('');

                $.ajax({
                    url: '/api/AppointmentsApi',
                    type: 'GET',
                    success: function(data) {
                        $('#loading').hide();
                        displayAppointments(data);
                    },
                    error: function() {
                        $('#loading').hide();
                        alert('Veri yüklenirken hata oluştu!');
                    }
                });
            }

            // İstatistikleri yükle (REST API)
            function loadStatistics() {
                $.ajax({
                    url: '/api/AppointmentsApi/Statistics',
                    type: 'GET',
                    success: function(data) {
                        $('#statTotal').text(data.totalAppointments);
                        $('#statPending').text(data.pendingAppointments);
                        $('#statConfirmed').text(data.confirmedAppointments);
                        $('#statCompleted').text(data.completedAppointments);
                        $('#statCancelled').text(data.cancelledAppointments);
                        $('#statRevenue').text(data.totalRevenue.toFixed(2) + '₺');
                        $('#statisticsCard').slideDown();
                    },
                    error: function() {
                        alert('İstatistik yüklenirken hata oluştu!');
                    }
                });
            }

            // Randevuları tabloda göster
            function displayAppointments(appointments) {
                if (appointments.length === 0) {
                    $('#appointmentsBody').html('<tr><td colspan="7" class="text-center text-muted">Randevu bulunamadı</td></tr>');
                    $('#resultCount').text('0');
                    return;
                }

                let html = '';
                appointments.forEach(function(app) {
                    let statusBadge = '';
                    switch(app.status) {
                        case 'Pending':
                            statusBadge = '<span class="badge bg-warning">Bekliyor</span>';
                            break;
                        case 'Confirmed':
                            statusBadge = '<span class="badge bg-success">Onaylı</span>';
                            break;
                        case 'Completed':
                            statusBadge = '<span class="badge bg-info">Tamamlandı</span>';
                            break;
                        case 'Cancelled':
                            statusBadge = '<span class="badge bg-danger">İptal</span>';
                            break;
                    }

                    html += `
                        <tr>
                            <td>${app.appointmentDate}</td>
                            <td>${app.startTime} - ${app.endTime}</td>
                            <td>${app.memberName}<br><small class="text-muted">${app.memberEmail}</small></td>
                            <td>${app.trainerName}</td>
                            <td>${app.serviceName}</td>
                            <td>${app.totalPrice} ₺</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });

                $('#appointmentsBody').html(html);
                $('#resultCount').text(appointments.length);
            }
        });
    </script>
}
